<!-- chat/templates/chat/index.html -->
{% extends "base.html" %}
{% block extra_style %}
<!--Asked chatgpt for help with ui design 12/9/2025 -->
    <style>
    .user-item {
        display: inline-block;
        padding: 5px 10px;
        margin: 5px;
        background-color: #e0e0e0;
        border-radius: 5px;
        cursor: pointer;
    }
    .user-item:hover {
        background-color: #d0d0d0;
    }

    .list-group-item {
        text-decoration: underline;
    }

    .list-group-item:hover {
        text-decoration: none;
        background-color: #f0f0f0;
    }
    </style>
{% endblock %}

{% block title %}Chat Rooms{% endblock %}

{% block content %}
<div class="container my-5">
        <h1>Chat Rooms</h1>
        <br>
        {% for room in user.profile.get_accessible_rooms %}
            <a href="{% url 'room' room_id=room.id %}" class="list-group-item list-group-item-action d-flex align-items-center">
                {{ room.title }}
                {% if room.id in unread_rooms %}
                    <span class="badge bg-primary rounded-pill">&bull;</span>
                {% endif %}
            </a>
        {% empty %}
            <div class="text-muted">No rooms available.</div>
        {% endfor %}
    </div>

    <div class="card shadow-sm mb-4 p-3">
        <h5>Start a chat with someone</h5>
        <div class="input-group mt-2">
            <input id="computing-id" type="text" class="form-control" placeholder="Enter computing ID">
            <button id="computing-id-submit" class="btn btn-primary">Enter</button>
        </div>
    </div>

    <div class="card shadow-sm mb-4 p-3">
        <h5>Create a group conversation</h5>
        <div class="input-group mt-2 mb-2">
            <input id="gc-computing-id" type="text" class="form-control" placeholder="Add computing ID"><br>
            <button id="add-user" class="btn btn-secondary">Add User</button>
        </div>
        <div id="gc-id-list" class="mb-2">
            <!-- List of added computing IDs will appear here -->
        </div>
        <button id="create-gc" class="btn btn-success w-100">Create Group Chat</button>
    </div>
</div>

<script>
    document.querySelector('#computing-id').focus();
    document.querySelector('#computing-id').onkeyup = function(e) {
        if (e.key === 'Enter') {  // enter, return
            document.querySelector('#computing-id-submit').click();
        }
    };

    document.querySelector('#computing-id-submit').onclick = async function(e) {
        const computingID = document.querySelector('#computing-id').value.trim();

        // check id
        const checkResponse = await fetch("{% url 'validate-other-user' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: new URLSearchParams({computing_id: computingID})
        });

        const checkData = await checkResponse.json()
        if (!checkResponse.ok) {
            alert(checkData.error || "An error occurred.")
            return
        }

        const response = await fetch("{% url 'start-chat' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: new URLSearchParams({computing_id: computingID})
        });

        const data = await response.json()
        if (response.ok) {
            window.location.pathname = '/chat/' + data.room_id + '/'
        } else {
            alert(data.error || "An error occurred.")
        }
    }
</script>
<script>
    // ChatGPT generated
    const addUserBtn = document.getElementById('add-user');
    const createGCBtn = document.getElementById('create-gc');
    const gcInput = document.getElementById('gc-computing-id');
    const gcList = document.getElementById('gc-id-list');

    let users = [];

    function renderUsers() {
        // Clear
        gcList.innerHTML = '';
        users.forEach((user, index) => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.textContent = user + ' âœ–';
            userDiv.onclick = () => {
                users.splice(index, 1); // remove user on click
                renderUsers();
            };
            gcList.appendChild(userDiv);
        });
    }

    // Add user
    addUserBtn.addEventListener('click', async () => {
        // check id
        const computingID = gcInput.value.trim();
        const response = await fetch("{% url 'validate-other-user' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: new URLSearchParams({computing_id: computingID})
        });

        const data = await response.json()
        if (!response.ok) {
            alert(data.error || "An error occurred.")
            return
        }

        if (computingID && !users.includes(computingID)) {
            users.push(computingID);
            renderUsers();
            gcInput.value = '';
            gcInput.focus();
        }
    });

    createGCBtn.onclick = async function(e) {
        if (users.length === 0) {
            alert('Add at least one user to create a group chat.');
            return;
        }
        const response = await fetch("{% url 'start-group-chat' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({computing_ids: users})
        });

        const data = await response.json()
        if (response.ok) {
            window.location.pathname = '/chat/' + data.room_id + '/'
        } else {
            alert(data.error || "An error occurred.")
        }
    }
</script>
{% endblock %}